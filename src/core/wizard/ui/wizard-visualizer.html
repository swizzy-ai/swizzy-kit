<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizard Visualizer | Production</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --background: #000000;
      --foreground: #ffffff;
      --accent-primary: #e43de7;
      --accent-primary-rgb: 228, 61, 231;
      --accent-secondary: #00dfd8;
      --border: #333333;
      --surface: #111111;
      --success: #e43de7;
      --warning: #f5a623;
    }

    body {
      background-color: var(--background);
      color: var(--foreground);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      overflow: hidden;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }

    .glass-header {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    .sidebar-border { border-right: 1px solid var(--border); }
    .right-sidebar-border { border-left: 1px solid var(--border); }

    .step-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border);
      background: #0a0a0a;
    }

    .step-card.active {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 112, 243, 0.1);
      transform: scale(1.01);
    }

    .step-card.completed {
      border-color: rgba(0, 112, 243, 0.3);
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .terminal-line {
      border-left: 2px solid var(--accent-primary);
      padding-left: 12px;
      margin-bottom: 8px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .badge-blue { background: rgba(0, 112, 243, 0.1); color: #0070f3; border: 1px solid rgba(0, 112, 243, 0.2); }
    .badge-green { background: rgba(0, 223, 216, 0.1); color: #00dfd8; border: 1px solid rgba(0, 223, 216, 0.2); }
    
    .instruction-panel {
      background: #050505;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    }

    .loader {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="h-screen flex flex-col">

  <!-- Header -->
  <header class="glass-header h-14 flex items-center justify-between px-6 z-50">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 bg-white rounded flex items-center justify-center">
          <div class="w-3 h-3 bg-black transform rotate-45"></div>
        </div>
        <span class="font-bold text-sm tracking-tight">WIZARD_CORE</span>
      </div>
      <div class="h-4 w-[1px] bg-neutral-800 mx-2"></div>
      <div class="flex gap-6 text-[11px] font-medium text-neutral-400">
        <div class="flex flex-col">
          <span class="text-[9px] text-neutral-600 uppercase">Tokens</span>
          <span class="text-white" id="total-tokens">0</span>
        </div>
        <div class="flex flex-col">
          <span class="text-[9px] text-neutral-600 uppercase">Rate</span>
          <span class="text-white" id="token-rate">0/s</span>
        </div>
      </div>
    </div>
    
    <div class="flex items-center gap-4">
      <div id="status-badge" class="badge badge-blue flex items-center gap-2">
        <div class="w-1.5 h-1.5 rounded-full bg-current"></div>
        <span id="status-text">Ready</span>
      </div>
      <div class="h-8 w-8 rounded-full bg-neutral-900 border border-neutral-800 flex items-center justify-center overflow-hidden">
        <img src="/placeholder.svg?height=32&width=32" alt="user" />
      </div>
    </div>
  </header>

  <div class="flex-1 flex overflow-hidden">
    <!-- Left Sidebar: Context -->
    <aside class="w-72 sidebar-border flex flex-col bg-[#050505]">
      <div class="p-4 border-bottom border-neutral-900 flex items-center justify-between">
        <span class="text-[10px] uppercase font-bold text-neutral-500 tracking-widest">Context Data</span>
        <i class="fas fa-database text-[10px] text-neutral-600"></i>
      </div>
      <div id="context-list" class="flex-1 overflow-y-auto p-4 space-y-3">
        <!-- Context Items -->
      </div>
    </aside>

    <!-- Main Content: Step Flow -->
    <main class="flex-1 overflow-y-auto bg-black scroll-smooth">
      <div class="max-w-3xl mx-auto py-12 px-6">
        <div class="flex flex-col gap-8 relative" id="steps-container">
          <!-- Timeline Line -->
          <div class="absolute left-6 top-8 bottom-8 w-[1px] bg-neutral-800 -z-10"></div>
          
          <!-- Steps dynamic -->
        </div>
      </div>
    </main>

    <!-- Right Sidebar: Instructions & Live Feed -->
    <aside class="w-80 right-sidebar-border flex flex-col instruction-panel">
      <div class="p-4 border-b border-neutral-900 flex items-center justify-between">
        <span class="text-[10px] uppercase font-bold text-neutral-500 tracking-widest">Execution Log</span>
        <div class="flex gap-2">
          <div class="w-2 h-2 rounded-full bg-neutral-800"></div>
          <div class="w-2 h-2 rounded-full bg-neutral-800"></div>
        </div>
      </div>
      <div id="instruction-feed" class="flex-1 p-4 overflow-y-auto text-[12px] leading-relaxed text-neutral-300">
        <div class="terminal-line text-neutral-500">System initialized. Waiting for command...</div>
      </div>
      
      <!-- Controls -->
      <div class="p-6 border-t border-neutral-900 bg-black">
        <div class="flex gap-2">
          <button id="start-btn" class="flex-1 h-10 bg-white text-black text-[12px] font-bold rounded flex items-center justify-center gap-2 hover:bg-neutral-200 transition-colors">
            <i class="fas fa-play text-[10px]"></i> START
          </button>
          <button id="pause-btn" class="hidden flex-1 h-10 bg-neutral-900 text-white text-[12px] font-bold rounded border border-neutral-800 flex items-center justify-center gap-2 hover:bg-neutral-800 transition-colors">
            <i class="fas fa-pause text-[10px]"></i> PAUSE
          </button>
          <button id="stop-btn" class="w-10 h-10 bg-neutral-900 text-red-500 text-[12px] rounded border border-neutral-800 flex items-center justify-center hover:bg-red-500/10 transition-colors">
            <i class="fas fa-stop"></i>
          </button>
          <button id="replay-btn" class="w-10 h-10 bg-neutral-900 text-neutral-400 text-[12px] rounded border border-neutral-800 flex items-center justify-center hover:bg-neutral-800 transition-colors">
            <i class="fas fa-redo"></i>
          </button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    class WizardEngine {
      constructor() {
        this.ws = null;
        this.steps = new Map();
        this.context = new Map();
        this.state = {
          isRunning: false,
          isPaused: false,
          totalTokens: 0,
          currentStepId: null
        };
        
        this.init();
      }

      init() {
        this.setupWebSocket();
        this.setupListeners();
        this.log("Wizard Engine V4.0 ready for deployment.");
      }

      setupWebSocket() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${location.host}`;
        
        this.ws = new WebSocket(wsUrl);
        
        this.ws.onopen = () => {
          this.log("Connection established with production node.");
          this.updateConnectionUI(true);
        };

        this.ws.onmessage = (e) => {
          const data = JSON.parse(e.data);
          this.handleMessage(data);
        };

        this.ws.onclose = () => {
          this.log("Connection lost. Retrying in 5s...", "error");
          this.updateConnectionUI(false);
          setTimeout(() => this.setupWebSocket(), 5000);
        };
      }

      handleMessage(data) {
        if (data.type === 'batch') {
          data.messages.forEach(m => this.handleMessage(m));
          return;
        }

        switch(data.type) {
          case 'wizard_start': this.initSteps(data.steps); break;
          case 'step_update': this.updateStep(data); break;
          case 'token_update': this.updateTokens(data); break;
          case 'context_update': this.updateContext(data); break;
          case 'status_update': this.updateStatus(data.status); break;
        }
      }

      initSteps(steps) {
        const container = document.getElementById('steps-container');
        container.innerHTML = '<div class="absolute left-6 top-8 bottom-8 w-[1px] bg-neutral-800 -z-10"></div>';
        this.steps.clear();

        const flatSteps = Array.isArray(steps[0]) ? steps[0] : steps;
        
        flatSteps.forEach(step => {
          const el = this.createStepElement(step);
          container.appendChild(el);
          this.steps.set(step.id, { el, data: step });
        });
      }

      createStepElement(step) {
        const div = document.createElement('div');
        div.id = `step-${step.id}`;
        div.className = `step-card p-6 rounded-xl flex gap-6 relative transition-all duration-500 opacity-40`;
        div.innerHTML = `
          <div class="flex-shrink-0 w-12 h-12 rounded-full border-2 border-neutral-800 bg-black flex items-center justify-center z-10 step-icon-container">
            <span class="text-neutral-500 font-mono text-xs">${step.id.split('-').pop() || '01'}</span>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-bold text-white">${step.id}</h3>
              <div class="flex items-center">
                <span class="text-[10px] text-neutral-600 font-mono uppercase status-label">Waiting</span>
                <button class="replay-btn hidden text-neutral-500 hover:text-white text-xs ml-2" onclick="engine.sendMessage({ type: 'goto', stepId: '${step.id}' })"><i class="fas fa-redo"></i></button>
              </div>
            </div>
            <p class="text-[12px] text-neutral-500 leading-relaxed mb-4">${step.instruction || 'Processing...'}</p>
            <div class="step-content hidden border-t border-neutral-900 pt-4 mt-4">
              <!-- Dynamic form fields -->
            </div>
          </div>
        `;
        return div;
      }

      updateStep(data) {
        const step = this.steps.get(data.stepId);
        if (!step) return;

        const { el } = step;
        el.className = `step-card p-6 rounded-xl flex gap-6 relative transition-all duration-500 ${data.status}`;

        const iconContainer = el.querySelector('.step-icon-container');
        const statusLabel = el.querySelector('.status-label');
        const content = el.querySelector('.step-content');

        if (data.status === 'current') {
          el.classList.add('active', 'opacity-100');
          iconContainer.innerHTML = '<div class="loader"></div>';
          iconContainer.style.borderColor = 'var(--accent-primary)';
          statusLabel.textContent = 'Running';
          statusLabel.className = 'text-[10px] font-mono uppercase status-label pulse';
          statusLabel.style.color = 'var(--accent-primary)';
          el.querySelector('.replay-btn').classList.add('hidden');
          this.log(`Executing: ${data.stepId} - ${data.instruction || 'Processing...'}`);

          if (data.fields && data.fields.length > 0) {
            this.createStepForm(content, data.stepId, data.fields);
            content.classList.remove('hidden');
          } else if (data.instruction) {
             const instEl = document.createElement('div');
             instEl.className = 'text-[11px] text-neutral-400 bg-neutral-900/50 p-3 rounded mt-2 border border-neutral-800';
             instEl.innerHTML = marked.parse(data.instruction);
             content.innerHTML = '';
             content.appendChild(instEl);
             content.classList.remove('hidden');
           }

          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (data.status === 'completed') {
          el.classList.add('completed', 'opacity-100');
          el.classList.remove('active');
          iconContainer.innerHTML = '<i class="fas fa-check text-[12px]"></i>';
          iconContainer.style.borderColor = 'rgba(var(--accent-primary-rgb), 0.3)';
          iconContainer.querySelector('i').style.color = 'var(--accent-primary)';
          statusLabel.textContent = 'Done';
          statusLabel.className = 'text-[10px] text-neutral-500 font-mono uppercase status-label';
          el.querySelector('.replay-btn').classList.remove('hidden');

          if (data.data) {
            const outputEl = document.createElement('div');
            outputEl.className = 'text-[11px] text-neutral-300 bg-neutral-900/50 p-3 rounded mt-2 border border-neutral-800 font-mono relative';
            const preEl = document.createElement('pre');
            preEl.className = 'whitespace-pre-wrap break-words max-h-64 overflow-y-auto';
            preEl.textContent = typeof data.data === 'string' ? data.data : JSON.stringify(data.data, null, 2);
            const copyBtn = document.createElement('button');
            copyBtn.className = 'absolute top-2 right-2 text-neutral-500 hover:text-white text-xs';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.onclick = () => {
              navigator.clipboard.writeText(preEl.textContent);
              copyBtn.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i>', 1000);
            };
            outputEl.appendChild(preEl);
            outputEl.appendChild(copyBtn);
            content.innerHTML = '';
            content.appendChild(outputEl);
            content.classList.remove('hidden');
          }
        }
      }

      updateContext(data) {
        this.context.clear();
        Object.entries(data.context).forEach(([key, value]) => {
          this.context.set(key, value);
        });

        const list = document.getElementById('context-list');
        list.innerHTML = '';

        Object.entries(data.context).forEach(([key, value]) => {
          const item = document.createElement('div');
          item.className = 'p-3 bg-neutral-900 border border-neutral-800 rounded-lg group cursor-pointer hover:border-neutral-700 transition-all';

          const type = Array.isArray(value) ? 'ARRAY' : typeof value;
          const displayContent = typeof value === 'string' ? value :
                                 Array.isArray(value) ? JSON.stringify(value, null, 2) :
                                 JSON.stringify(value, null, 2);

          item.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="text-[11px] font-bold text-neutral-300">${key}</span>
              <div class="flex items-center gap-1">
                <span class="text-[9px] text-neutral-600 uppercase font-mono">${type.toUpperCase()}</span>
                <button class="text-neutral-500 hover:text-white text-xs copy-btn" data-key="${key}">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <pre class="text-[10px] text-neutral-500 whitespace-pre-wrap break-words max-h-32 overflow-y-auto">${displayContent}</pre>
          `;

          item.querySelector('.copy-btn').onclick = (e) => {
            e.stopPropagation();
            const btn = e.target.closest('.copy-btn');
            const key = btn.dataset.key;
            const value = this.context.get(key);
            const copyText = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
            navigator.clipboard.writeText(copyText);
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i>', 1000);
          };

          list.appendChild(item);
        });
      }

      updateStatus(status) {
        this.state = { ...this.state, ...status };
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');

        if (status.isRunning && !status.isPaused) {
          startBtn.classList.add('hidden');
          pauseBtn.classList.remove('hidden');
          statusBadge.className = 'badge badge-green flex items-center gap-2';
          statusText.textContent = 'Running';
        } else if (status.isPaused) {
          if (status.isStepMode) {
            pauseBtn.innerHTML = '<i class="fas fa-step-forward text-[10px]"></i> NEXT STEP';
            pauseBtn.onclick = () => this.sendMessage({ type: 'step_forward' });
          } else {
            pauseBtn.innerHTML = '<i class="fas fa-play text-[10px]"></i> RESUME';
            pauseBtn.onclick = () => this.sendMessage({ type: 'resume' });
          }
          statusText.textContent = 'Paused';
        } else {
          startBtn.classList.remove('hidden');
          pauseBtn.classList.add('hidden');
        }
      }

      log(msg, type = "info") {
        const feed = document.getElementById('instruction-feed');
        const line = document.createElement('div');
        line.className = `terminal-line ${type === 'error' ? 'text-red-500 border-red-500' : 'text-neutral-300'}`;
        line.innerHTML = `<span class="text-neutral-600 mr-2">[${new Date().toLocaleTimeString([], {hour12: false})}]</span> ${msg}`;
        feed.appendChild(line);
        feed.scrollTop = feed.scrollHeight;
      }

      setupListeners() {
        document.getElementById('start-btn').onclick = () => this.sendMessage({ type: 'run' });
        document.getElementById('pause-btn').onclick = () => this.sendMessage({ type: 'pause' });
        document.getElementById('stop-btn').onclick = () => this.sendMessage({ type: 'stop' });
        document.getElementById('replay-btn').onclick = () => this.sendMessage({ type: 'resume' });
      }

      sendMessage(message) {
        if (this.ws?.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(message));
          this.log(`Manual trigger: ${message.type.toUpperCase()}`);
        }
      }

      updateConnectionUI(connected) {
        const badge = document.getElementById('status-badge');
        badge.classList.toggle('opacity-50', !connected);
      }
      
      updateTokens(data) {
        document.getElementById('total-tokens').textContent = data.totalTokens.toLocaleString();
      }
    }

    const engine = new WizardEngine();
  </script>
</body>
</html>
